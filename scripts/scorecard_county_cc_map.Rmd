---
title:"Mapping Earnings Data from College Scorecard"
output:html_document
---



```{r,echo=FALSE,warning=FALSE,message=FALSE,warning=FALSE,comment=FALSE,fig.width=10}


################################################################################
## Analyzing new college score card data
## 9/12/2015
################################################################################

options(stringsAsFactors = FALSE)
rm(list=ls())
library(tidyr)
library(dplyr)
library(RColorBrewer)
library(rgeos)
library(rgdal)
library(maptools)
library(leaflet)
library(htmlwidgets)
library(knitr)
opts_knit$set(root.dir="../output/")
## This file expects to be in a directory with structure
## ./data
## ./scripts
## ./output

#State and county leaflet map plots of earnings

year<-2011

shapefile<-"tl_2011_us_county"

#put your tiger directory here
#From: ftp://ftp2.census.gov/geo/tiger/TIGER2011/COUNTY/
tiger_dir<-"/Users/doylewr/TIGER2011/COUNTY/"

##Todo: download and unzip into data directory

cs<-read.csv(paste0("../data/MERGED",year,"_PP.csv"),na.strings="NULL")

#All lower case names
names(cs)<-tolower(names(cs))

#IPEDS-based dataset b/c I'm lazy
inst_all<-read.csv("../data/insts.csv")

## REPORT CATEGORIES -----------------------------------------------------------
##
## 1 = Public Doctoral (includes extensive and intensive) 4-year
## 2 = Public Non-Doctoral (all other 4-years)
## 3 = Private Doctoral (as above)
## 4 = Private Non-Doctoral (as above)
## 5 = Public 2 year (>= 90% of degrees at Associateâ€™s or certificate level)
## 6 = Public Vocational/Technical
## 
## -----------------------------------------------------------------------------

county_map_cs<-function(myvar,var_describe,legend_title,select_group){

## This function expects that you have college scorecard data
  ## Also expects insts data file stored in ../data
  ## And Census county tiger shapefile stored in your tiger directory
  
select_cols<-c("unitid", #unitid, always
               "instnm",  #name, to be sure
                myvar # selected variable
               )

cs_sub<-select(cs,one_of(select_cols))

cs_sub$myvar<-unlist(cs_sub[myvar])

cs_sub$myvar<-as.numeric(cs_sub$myvar)

#If expressed as a proportion change to percent
if(max(cs_sub$myvar,na.rm=TRUE)<=1){
cs_sub$myvar<-cs_sub$myvar*100
}

inst_all<-filter(inst_all,group%in%select_group)

cs_sub<-left_join(inst_all,cs_sub,by="unitid")

#Just continental US for now

exclude.list<-c("AK","AS","DC","FM","GU","HI","MP","PR")

cs_sub<-filter(cs_sub,!(cs_sub$stabbr%in%exclude.list))

##Create shapefile

#Drop missing observations
cs_sub<-filter(cs_sub,is.na(myvar)==FALSE)

#Get longitude and latitude
inst_points<-data.frame(cs_sub$longitud,cs_sub$latitude)

cs_sub<-select(cs_sub,-latitude,-longitud)

#This creates a spatial points data frame using long and lat from IPEDS
#NAD83= epsg:4269 as projection

inst_sp <- SpatialPointsDataFrame(coords=inst_points,data=cs_sub, 
                    proj4string=CRS("+init=epsg:4269"))

if(file.exists(paste0("../data/county_shape_",myvar,".Rda"))==FALSE){

# Get appropriate tiger shapefile

county_shape<-readOGR(dsn=tiger_dir,
                     layer=shapefile,
                     verbose=FALSE)

county_shape_simple<-gSimplify(county_shape,tol=.001,topologyPreserve = TRUE)

county_shape<-SpatialPolygonsDataFrame(county_shape_simple,data=county_shape@data)

#Correct Projection: NAD83==epsg:4269
county_shape<-spTransform(county_shape,CRS("+init=epsg:4269"))

names(county_shape@data)<-tolower(names(county_shape@data))

cs_sub$fips<-sprintf("%02s",cs_sub$fips)

county_shape<-county_shape[county_shape$statefp%in%cs_sub$fips,]

#Krige over areas: push output back

#Inverse distance weighted interpolation

print("Kriging over counties  . . . .")

idw.fit<-idw(myvar~1,
             locations=inst_sp,
             newdata=county_shape,
             na.action=na.pass)

#Pull predictions

idw.fit.preds<-data.frame(idw.fit$var1.pred)

#Get ids and make them rownames

row.names(idw.fit.preds)<-as.character(county_shape$geoid)

row.names(county_shape)<-as.character(county_shape$geoid)

 #Column names

names(idw.fit.preds)<-"myvar"

#Merge back into data frame

county_shape<-spCbind(county_shape,idw.fit.preds)

save(county_shape,file=paste0("../data/county_shape_",myvar,".Rda"))

} else{ 
  load(paste0("../data/county_shape_",myvar,".Rda")) 
}

#####################################
## Draw Map
#####################################

#Colors
#Red=BAD

my.colors<-brewer.pal(11,"RdYlGn")

my.pal<-colorRampPalette(colors=c(my.colors[1],my.colors[6],my.colors[11]))(10)

npal <- colorNumeric(pal=my.pal, domain=county_shape@data$myvar)

county_popup <- paste0(county_shape@data$namelsad,
                      var_describe, 
                       prettyNum(county_shape@data$myvar,
                                 big.mark=",",
                                 scientific=FALSE,
                                 digits=0)
                    )

inst_popup<-paste0(as.character(inst_sp@data$instnm.x),
                   var_describe,
                   prettyNum(inst_sp$myvar,
                            big.mark=",",
                            scientific=FALSE,
                            digits=0)
                   )

#Set bounding box for plotting
b<-as.vector(bbox(county_shape))

#Expands limits slighlty
b[1]<-b[1]*1.03
b[2]<-b[2]-(b[2]*.03)
b[3]<-b[3]-(b[3]*.03)
b[4]<-b[4]*1.03

#Create map
county_map<-leaflet(county_shape) %>%
  
  #Overlay counties    
  addPolygons(stroke=TRUE,
              opacity=.25,
              fill=TRUE,
              color=~npal(county_shape@data$myvar),
              fillOpacity=.75,
              popup=county_popup
                )%>%
  
  #Legend
  addLegend("bottomleft",
            pal=npal,
            title=legend_title,
            values=~county_shape@data$myvar
              )%>%

#Overlay Instititions
    addCircleMarkers(lng=inst_sp@coords[,1],
                     lat=inst_sp@coords[,2],
                     color="black",
                     fillColor="black",
                     fillOpacity=.25,
                     stroke=FALSE,
                     radius=5,
                     group="Institutions",
                     popup=inst_popup
               )%>%  
  
#Layer Control
    addLayersControl(
        overlayGroups = c("Institutions"),
        options = layersControlOptions(collapsed = FALSE)
    )%>%
  
# Leave insts off at first  
  hideGroup("Institutions")%>%

# Add tiles        
  addProviderTiles("Stamen.Toner",options=list(minZoom=4,zoom=4,maxZoom=13))%>%

  #Set boundaries
  setMaxBounds(lng1=b[1],lat1=b[2],lng2=b[3],lat2=b[4]) 
   
county_map
}

```

County Level Estimates: Earnings of Public Two-Year Attendees Ten Years After Entry
=========================================
```{r,echo=FALSE,warning=FALSE,message=FALSE,comment=FALSE,fig.width=10}
##Note that this will take LOONG time on first run

myvar<-"md_earn_wne_p10"

county_map_earn<-county_map_cs(myvar="md_earn_wne_p10",
              var_describe="<br/> Median earnings of attendeees 10 yrs after entry: ",
              legend_title="Median Earnings of attendees <br/> 10 yrs after entry",
              select_group=5)

county_map_earn
```

This map displays county level estimates of the earnings among working attendees of local public two-year colleges ten years after first attendance. The data only include attendees who took some form of federal financial aid (loans or grants).

The map is interactive: click on any county for county-level estimate. Zoom using "+/-" in upper left corner. Pan using mouse or keyboard arrows. Check "institutions" box to see institutional location. Click on institutions to see scorecard data for that institution. 

County-level estimates are based on the distance-weighted measures for nearby institutuons, with nearest institutions weighted highest.

Variable name: `r myvar`, 

Data from college scorecard dataset, 2011: [https://collegescorecard.ed.gov/data/](https://collegescorecard.ed.gov/data/)

Github Repo here: 

Comments welcome, better code even more so: w.doyle(at)vanderbilt.edu, (at)wdoyle42.
