---
title: Mapping Earnings Data from College Scorecard
output: html_document
---

<!--

PROJ: Analyzing new college score card data
AUTH: Will Doyle and Benjamin Skinner
INIT: 12 September 2015

-->

```{r,echo=F,warning=F,message=F,comment=F}
################################################################################
## SET YEAR, SCORECARD, AND INSTITUTION VARIABLE OPTIONS
################################################################################

## Set the year for your map. You must have all relevelant files for
## the program to run

## year option
year <- 2011

## outcome columns in addition to required
outcome <- c('md_earn_wne_p10')
var_describe <- 'Median earnings of attendeees 10 yrs after entry'

required <- c('unitid','instnm')
sccols <- c(required, outcome)

## REPORT CATEGORIES -----------------------------------------------------------
##
## 1 = Public Doctoral (includes extensive and intensive) 4-year
## 2 = Public Non-Doctoral (all other 4-years)
## 3 = Private Doctoral (as above)
## 4 = Private Non-Doctoral (as above)
## 5 = Public 2 year (>= 90% of degrees at Associateâ€™s or certificate level)
## 6 = Public Vocational/Technical
## 
## -----------------------------------------------------------------------------

## select category
instcat <- 5

```


```{r,echo=F,warning=F,message=F,comment=F}
################################################################################
## HEADER INFORMATION
################################################################################

## read in strings as strings, not factors
options(stringsAsFactors = FALSE)

##  package list
libs <- c('dplyr',                      # make data wrangling easier
          'gstat',                      # kriging
          'geojsonio',                  # to handle geojson data type
          'htmlwidgets',                # way to bind javascript libraries
          'knitr',                      # combine R code and markdown
          'leaflet',                    # interactive mapping module
          'maptools',                   # mapping projections
          'RColorBrewer',               # create color palettes
          'readr',                      # faster reading of large csv files
          'rgdal',                      # interact with gdal GIS framework
          'rgeos',                      # interact with geos GIS framework
          'tidyr')                      # make data wrangling easier

## load packages
lapply(libs, require, character.only = T)

## set relative directory paths
ddir <- '../data/'
mdir <- '../map/'

## projection (do not change unless there's a specific reason)
proj <- CRS('+init=epsg:4269')

## add icon for schools
schoolIcon <- makeIcon(iconUrl = paste0(ddir, 'college-24.svg'),
                       iconWidth = 35, iconHeight = 35)

```


```{r,echo=F,warning=F,message=F,comment=F}
################################################################################
## LOAD DATA
################################################################################

## load county shapefile (national level)
## shapefile <- paste0('tl_', year, '_us_county')
shapefile <- paste0('cb_2013_us_county_500k')

## read in college scorecard data
csdat <- read_csv(paste0(ddir, 'MERGED', year, '_PP.csv'))

## set mask based on columns set above
keep <- sapply(sccols, FUN = function(x) { grep(x, tolower(names(csdat))) })

## subset
csdat <- csdat %>% select(keep)

## read in IPEDS institution GEO files
inst_all <- read_csv(paste0(ddir, 'insts.csv'))

```

```{r,echo=F,warning=F,message=F,comment=F}
################################################################################
## FUNCTIONS
################################################################################

instPointsSpatial <- function(dat,                  # merged score data
                              outcome_var,          # outcome variable
                              proj,                 # projection to use
                              save.file = TRUE      # option to save result
                              ) {

    ## pop longitude and latitude from data frame
    dat <- dat %>% filter(!is.na(outcome_var))
    inst_points <- data.frame(dat %>% select(longitud,latitude))
    dat <- data.frame(dat %>% select(-latitude, -longitud))
    
    ## creates a spatial points data frame using long and lat from IPEDS
    inst_sp <- SpatialPointsDataFrame(coords = inst_points,
                                      data = dat, 
                                      proj4string = proj)

    ## save spatial data frame
    filename <- paste0(mdir, 'institutional_points.geojson')
    if(save.file) {
        ## save(inst_sp, file = filename)
        geojson_write(inst_sp, file = filename)
    }
    
    ## return
    return(inst_sp)
}

krigeMap <- function(ddir,                          # data directory
                     dat,                           # merged scorecard data
                     inst_sp,                       # institution spatial
                     outcome_var,                   # variable to krige
                     sf,                            # shapefile 
                     proj = CRS('+init=epsg:4269'), # projection to use
                     save.file = TRUE               # option to save result
                     ) {

    ## ////////////////////////////////////////////////////////////////////
    ## This function will krige the outcome data and return a spatial
    ## object with the proper data. It takes a long time to run so it
    ## defaults to save the output, which can then be called the next time.
    ## The save may be overwritten by switching save.file to FALSE.
    ## ////////////////////////////////////////////////////////////////////
    
    ## =================================
    ## SET UP DATA
    ## =================================

    ## drop missing observations
    dat <- dat %>% filter(!is.na(outcome_var))
    
    ## get appropriate tiger shapefile
    county_shape <- readOGR(dsn = ddir,
                            layer = sf,
                            verbose = FALSE)
  
    ## correct projection: epsg:4269
    county_shape <- spTransform(county_shape, proj)

    ## lower names in attached spatial data
    names(county_shape@data) <- tolower(names(county_shape@data))

    ## reformat FIPS codes so they have leading zeros
    dat$fips <- sprintf('%02s', dat$fips)

    ## subset to states in scorecard data
    county_shape <- county_shape[county_shape$statefp %in% dat$fips,] 

    ## =================================
    ## KRIGE OVER AREAS
    ## =================================

    ## inverse distance weighted interpolation
    idw.fit <- idw(outcome_var ~ 1,
                   locations = inst_sp,
                   newdata = county_shape,
                   na.action = na.pass)
    
    ## pull predictions
    idw.fit.preds <- data.frame(idw.fit$var1.pred)
    
    ## get ids and make them rownames
    row.names(idw.fit.preds) <- as.character(county_shape$geoid)
    row.names(county_shape) <- as.character(county_shape$geoid)
    
    ## column names
    names(idw.fit.preds) <- 'outcome_var'
        
    ## merge back into data frame
    county_shape <- spCbind(county_shape, idw.fit.preds)

    ## =================================
    ## SAVE AND OUTPUT
    ## =================================

    ## map data file ./dir/name
    mapname <- paste0(mdir, 'county_shape_', outcome_var, '_', year, '.geojson' )
    if(save.file) {
        ## save(county_shape, file = mapname)
        geojson_write(county_shape, file = mapname)
    }

    ## return spatial data file
    return(county_shape)
}
  
mapSC <- function(countylayer,          # county map data
                  instlayer,            # institution points layer
                  outcome_var,          # scorecard outcome data
                  var_describe          # description for map
                  ) {

    ## ////////////////////////////////////////////////////////////////////
    ## This function produces a leaflet map from the spatial objects
    ## ////////////////////////////////////////////////////////////////////

    ## =================================
    ## SET COLORS
    ## =================================

    ## read in diverging palette
    my.colors <- brewer.pal(11,'RdYlGn')

    ## create color ramp (red == bad ---> green == good)
    my.pal <- colorRampPalette(colors = c(my.colors[1],
                                          my.colors[6],
                                          my.colors[11]))(10)
    ## numeric palette
    npal <- colorNumeric(pal = my.pal,
                         domain = countylayer@data[[outcome_var]])


    ## =================================
    ## ADJUST LABELS
    ## =================================

    ## split long variable description into 2 if long
    split <- as.integer(length(strsplit(var_describe, ' ')[[1]]) / 2)
    if(split > 3) {
        lo <- split; hi <- split + 1
        legend_title <- strsplit(var_describe, ' ')[[1]]
        legend_title <- paste(paste(legend_title[1:lo], collapse = ' '),
                              '<br/>',
                              paste(legend_title[hi:length(legend_title)],
                                    collapse = ' '), collapse = '')
    } else {
        legend_title <- var_describe
    }

    ## add break and colon to variable description for popup
    var_describe <- paste0('<br/>', var_describe, ': $')
     
    ## =================================
    ## CREATE POPUPS
    ## =================================
       
    county_popup <- paste0(paste0(countylayer@data$name, ' County'),
                           var_describe, 
                           prettyNum(countylayer@data$outcome_var,
                                     big.mark = ',',
                                     scientific = FALSE,
                                     digits = 0)
                           )
    
    inst_popup <- paste0(as.character(instlayer@data$instnm),
                         var_describe,
                         prettyNum(instlayer[[outcome_var]],
                                   big.mark = ',',
                                   scientific = FALSE,
                                   digits = 0)
                         )
    
    ## set bounding box for plotting
    b <- as.vector(bbox(countylayer))
    
    ## expands limits slighlty
    b[1] <- b[1] * 1.03
    b[2] <- b[2] - (b[2] * .03)
    b[3] <- b[3] - (b[3] * .03)
    b[4] <- b[4] * 1.03
   
    ## =================================
    ## CREATE LEAFLET MAP
    ## =================================
    
    county_map <- leaflet(countylayer) %>%
        ## overlay counties    
        addPolygons(stroke = TRUE,
                    opacity = .25,
                    fill = TRUE,
                    color = ~npal(countylayer@data$outcome_var),
                    fillOpacity = .65,
                    popup = county_popup
                    ) %>%
        ## legend
        addLegend('bottomleft',
                  pal = npal,
                  title = legend_title,
                  values = ~countylayer@data$outcome_var
                  ) %>%
        ## overlay instititions
        addMarkers(lng = instlayer@coords[,1],
                   lat = instlayer@coords[,2],
                   icon = schoolIcon,
                   pop = inst_popup,
                   group = 'Institutions',
                   ) %>%
        ## layer control for institutions
        addLayersControl(
            overlayGroups = c('Institutions'),
            options = layersControlOptions(collapsed = FALSE)
        ) %>%
        ## leave institutions off by default  
        hideGroup('Institutions') %>%
        ## add tiles        
        addProviderTiles('Stamen.TonerLite',
                         options = list(minZoom = 4,
                                        zoom = 4,
                                        maxZoom = 13)
                         ) %>%
        ## set boundaries
        setMaxBounds(lng1 = b[1],
                     lat1 = b[2],
                     lng2 = b[3],
                     lat2 = b[4]) 
    ## =================================
    ## RETURN MAP
    ## =================================
    
    return(county_map)
}

countyMapCS <- function(csdat,               # scorecard data
                        instdat,             # institutional data
                        outcome_var,         # scorecard outcome variable
                        select_group,        # institutional category
                        proj,                # projection to use
                        redraw_map = FALSE,  # ignore saved kriged map
                        redraw_inst = FALSE, # ignore saved inst. spatial df
                        ...                  # additional arguments
                        ){

    ## ////////////////////////////////////////////////////////////////////
    ## This function is a wrapper for the kriging and mapping functions.
    ## It expects that you have college scorecard data, 
    ## institutional data, shapefile data in the ../data/ directory
    ## ////////////////////////////////////////////////////////////////////

    ## convert outcome column to numeric
    suppressWarnings(
        dat <- csdat %>% mutate(outcome_var = as.numeric(.[[outcome_var]]))
        )
       
    ## if outcome variable expressed as a proportion change to percent
    if(max(dat$outcome_var, na.rm = TRUE) <= 1){
        dat$outcome_var <- dat$outcome_var * 100
    }

    ## drop states list
    dslist <-  c('AK','AS','DC','FM','GU','HI','MP','PR','PW')

    ## wrangle data
    mapdat <- instdat %>%
        filter(group %in% select_group,                # filter out non-group
               !(stabbr %in% dslist)) %>%              # drop non-lower 48
        select(unitid,
               fips,
               latitude,
               longitud,
               stabbr) %>% # subset
        left_join(dat, by = 'unitid')                  # join to cs data

    ## =================================
    ## READ IN SHAPEFILES
    ## =================================

    ## institutions spatial data file ./dir/name
    ## instname <-paste0(mdir, 'institutional_points.Rda')
    instname <-paste0(mdir, 'institutional_points.geojson')
 
    ## institutional data
    if(file.exists(instname) & !(redraw_inst)){
        ## load existing
        message('\nReading in institutional points layer')
        ## inst_sp <- get(load(instname))
        inst_sp <- readOGR(instname, layer = 'OGRGeoJSON')
    } else {
        ## create institutional spatial dataframe
        message('\nCreating spatial file for institutional points')
        inst_sp <- instPointsSpatial(mapdat, outcome_var, proj)
    }
    
    ## map data file ./dir/name
    ## mapname <- paste0(mdir, 'county_shape_', outcome_var, '_', year, '.Rda')
    mapname <- paste0(mdir, 'county_shape_', outcome_var, '_', year, '.geojson')
    
    if(file.exists(mapname) & !(redraw_map)){
        ## load existing
        message('\nReading in county layer')
        ## county_shape <- get(load(mapname))
        county_shape <- readOGR(mapname, layer = 'OGRGeoJSON')
    } else {
        ## create map
        message('\nKriging...will take a little bit...')
        county_shape <- krigeMap(ddir,mapdat,inst_sp,outcome_var,shapefile,proj)
    }

    ## =================================
    ## DRAW AND RETURN MAP
    ## =================================

    message('\nDrawing map')
    out.map <- mapSC(county_shape, inst_sp, outcome_var, var_describe)
    return(out.map)
}
```

County Level Estimates: Earnings of Public Two-Year Attendees Ten Years After Entry
=========================================
```{r, echo=F,warning=F,comment=F,fig.width=10}
################################################################################
## MAKE MAP
################################################################################

county_map_earn <- countyMapCS(csdat = csdat, instdat = inst_all,
                               outcome_var = outcome, select_group = instcat,
                               proj = proj, var_describe = var_describe)

print(county_map_earn)
```

This map displays county level estimates of the earnings among working attendees of local public two-year colleges ten years after first attendance. The data only include attendees who took some form of federal financial aid (loans or grants).

The map is interactive: click on any county for county-level estimate. Zoom using "+/-" in upper left corner. Pan using mouse or keyboard arrows. Check "institutions" box to see institutional location. Click on institutions to see scorecard data for that institution. 

County-level estimates are based on the distance-weighted measures for nearby institutuons, with nearest institutions weighted highest.

Variable name: `r print(outcome_var)`, 

Data from college scorecard dataset, 2011: [https://collegescorecard.ed.gov/data/](https://collegescorecard.ed.gov/data/)

Github Repo here: 

Comments welcome, better code even more so: w.doyle(at)vanderbilt.edu, (at)wdoyle42.
